Write up

# Network scanning

Bắt đầu với việc scanning xem IP của machine:

```bash
nmap -sn 10.10.8.0/24
```

![1a70b9d6927bdfaa2b44eb894020b2c2.png](../../../../_resources/611e4bda520141b0ad9f5176c602bae0.png)

Đặt **10.10.8.128** là **targethost** trong **/etc/hosts** để dễ dàng hơn trong việc ghi nhớ mục tiêu:

![5c611a96b339eace34b4a51e9d55033c.png](../../../../_resources/37714b09798b4737b23b45393760e158.png)

Sử dụng nmap với aggressive mode để enable OS detection, version detection, script scanning, traceroute:

```bash
nmap -A 10.10.8.128
```

![12e0ff85f83f1a4a0436eab6098fd145.png](../../../../_resources/6c036c649aa242c99bebd355491899a2.png)

Chỉ có mỗi port 80 của machine là open, vậy tiếp theo cần mở web bằng browser để xem.

# Tìm kiếm lỗ hổng trên web

Có một form dùng để tìm kiếm request đến result.php:
![6cb87c88af9214cf0f0536aac3819ac5.png](../../../../_resources/2a9fa9578e5e4f48b5207198642fe508.png)

Sử dụng thử một payload đơn giản:

```
abc' or 1=1 -- -
```

Kết quả là:
![adf8680ab3a9dabda8ee83f9a8fbf066.png](../../../../_resources/dfccdc56f0e04b838d9ed1794d2bfc99.png)

# Exploit

Để nhanh hơn kiểm tra sql injection bằng sqlmap: thực hiện tìm kiếm thử và dùng burpsuite bắt lại để lưu lại request để sử dụng sqlmap.

![bc81ebf418da79bef2707406c73d4221.png](../../../../_resources/e9ad43f562744152bfb034d0f3946511.png)

Sử dụng sqlmap:

```bash
sqlmap -r targethost_search_request.txt
```

![070e8520136852ecc7ac351630bac613.png](../../../../_resources/cfeb848c92124422bce670159df42318.png)

Thêm vài lệnh để dump thêm database trong các table, kết quả có 2 database: Staff, users. Dữ liệu trong từng database như sau:

![bf9589d2ccaed3c8a535ae079ea7f2e0.png](../../../../_resources/2f7ebb6ca38a4a2dac1fa304ad3764fd.png)

![fd3e74190670ad914e4e96bb9505dad4.png](../../../../_resources/dc7201f2733a4ce7b66a3d777304c95b.png)

![8a8d4bfed03d5121583b0f4d22abd87c.png](../../../../_resources/aae898debc654d4e918145c662ebd25a.png)

Với tài khoản admin đứng một mình, có lẻ đây là tài khoản để đăng nhập vào web, sử dụng trang crackstation để tìm ra password ban đầu vì password đã bị hash. Kết quả thu được là "**transorbital1**"

![8b7cc66ad4b012b65f047c5e45bf718c.png](../../../../_resources/22367693f3d84d31862bdc58c768829a.png)

Đăng nhập thành công nhưng chú ý một xíu sẽ thấy một thông báo "File dose not exist", tức là trang nhận thêm parameter nào đó để đọc file? Đó là parameter file (phần này là đoán chứ đọc write up cũng không thấy):

![5972ce3807db6015b3c42c459c3ea390.png](../../../../_resources/330f28fed9af4213b34e5df1fbe34827.png)

Nhưng file /etc/passwd cũng không giúp được gì, lay hoay đọc writeup và tìm hiểu thì biết được một kỹ thuật là **knock port**, đây là một kỹ thuật để bảo mật port, khi knocking đúng port và đúng trình tự xác định trước thì sẽ cho phép kết nối đến port nào đó. File cấu hình trình tự knock nằm ở **/etc/knockd.conf**:

![397926c219d3076c07b08743ca304e06.png](../../../../_resources/f40a72e498f94bee9a3431a29e0f01b8.png)

Sử dụng lệnh:

```bash
knock -v targethost 7469 8475 9842
```

Bây giờ scanning lại targethost đã có SSH:

![9e62c78ca97713b1c475a55c26df43cf.png](../../../../_resources/a73f2fdffd2c45ee947b2b0ba5120cd1.png)

Trong đây có cỡ chục tài khoản, sử dụng **hydra** để thử các username, password qua ssh. Đầu tiên xuất các username và password ra file:

![4a1b7e8c8c74634aa2e31eba38401777.png](../../../../_resources/8417abf29ec74ac5bd3e9becebac845c.png)

Dùng hydra:

```bash
hydra -C creds.txt targethost ssh
```

![77039f4eef0ee07a4c54201863e1ce93.png](../../../../_resources/62e5df4aa51e4f2f8f6d8dfbf6227542.png)

Đăng nhập thử thì thư mục chính không có gì, trừ user janitor có thư mục **.secrets-for-putin** gồm file **passwords-found-on-post-it-notes.txt**:

```
BamBam01
Passw0rd
smellycats
P0Lic#10-4
B4-Tru3-001
4uGU5T-NiGHts
```

Có thể đây là mật khẩu của một ai đó trong list đó, nhưng phải chuyển sang chế độ brutce force các trường hợp nên phải chia username và password thành 2 file, thêm các password mới vào và bắt đầu:

![0d7e9d1ae4f5515a1b7c689953652223.png](../../../../_resources/b7ba0a32f5754992b41f97cdf428f13a.png)

User đầu tiên xuất hiện mình đã thấy rằng đi đúng hướng vì lúc đầu thoáng nhìn trong danh sách thì fred là System admin:

![b1c63ca9cff76f6d14ecabc06a980f62.png](../../../../_resources/97e0e13ad36742b7abc2feb1939d4590.png)

Nhưng khi ssh vô thì thấy user này cũng không có gì cả, đọc writeup thì thấy họ dùng lệnh `sudo -l` để liệt kê ra các quyền đặt biệt (kiểm tra các lệnh với quyền root nhưng không cần password):

![1b9c46ec23f7aa95ee5ffec394ee64a5.png](../../../../_resources/61246973210a4599bd6d5f007dffba09.png)

Vậy fredf có thể thực thi file **/opt/devstuff/dist/test/test** với quyền root mà không cần mật khẩu.

![fb4cf09951702adc0a5089297fb419cc.png](../../../../_resources/0a93b48d3b8e477fbfcff1e32ab21cd2.png)

Chương trình cần thêm 2 tham số là read và append. Lùi ra một xíu có một chương trình python tại **/opt/devstuff/test.py**. Nhìn output của chương trình chắc rằng đây là code của chương trình lúc nãy.

![94a820c9611dbc92e5ec0b5ab2696851.png](../../../../_resources/ebe76223b3b04d69bd4a954cc1a8ec58.png)

Nội dung chương trình sẽ đọc nội dung file của tham số đầu tiên và thêm vào cuối file của tham số thứ 2. Vậy thêm vào file gì mà có được quyền root??? => **/etc/passwd**
Tìm hiểu về file /ect/passwd cái đã :))

![6140606cb94734c8c54f022c65314d21.png](../../../../_resources/437ed665908a4575a563b43588f364a8.png)

Sơ sơ là vậy, còn đầy đủ hơn thì xem ở [link này](https://kipalog.com/posts/Tep-tin--etc-shadow-trong-linux).

Đầu tiên tạo ra hash cho password:

```
$ openssl passwd -1 -salt h40huynh 123456
$1$h40huynh$NC6F6mHYM0eO.s.5QunQm.
```

Vậy chuỗi cần thêm vào là `hnhao:$1$h40huynh$NC6F6mHYM0eO.s.5QunQm.:0:0::/root:/bin/bash` để có được user hnhao:123456

Tada :))
![618202c0bc05507985e69bce83e3d0ee.png](../../../../_resources/5a7cdff2ec134f42bfa463e9ebe20294.png)
